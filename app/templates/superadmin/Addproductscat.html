{% extends "superadmin/adminbase.html" %}
{% load static %}
{% load custom_tags %}
{% block title %}{{ category.name }} Products{% endblock %}
{% block content %}

<main class="main-content-wrapper">
   <div class="container">
      <div class="row mb-8">
         <div class="col-md-12">
            <!-- Page header -->
            <div class="d-md-flex justify-content-between align-items-center">
               <div>
                  <h2>{{ category.name }} Products</h2>
                  <!-- Breadcrumb -->
                  <nav aria-label="breadcrumb">
                     <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="{% url 'admin-home' %}" class="text-inherit">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'products' %}" class="text-inherit">Product Categories</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Products by Category</li>
                     </ol>
                  </nav>
               </div>
            </div>
         </div>
      </div>

      <!-- ‚úÖ Bulk Delete Form (Single Form for Checkboxes + Button) -->
      <form method="POST" action="{% url 'delete_selected_products' %}" id="bulkDeleteForm">
         {% csrf_token %}
         <input type="hidden" name="category_id" value="{{ category.id }}">

         <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <div class="d-flex align-items-center gap-2">
    <a href="{% url 'add-products' category.id %}" class="btn btn-primary">+ Add Product</a>

    <!-- ‚úÖ Visibility Filter -->
    <select id="visibilityFilter" class="form-select form-select-sm" style="width:auto;">
      <option value="all">All Products</option>
      <option value="visible" {% if request.GET.visibility == 'visible' %}selected{% endif %}>Visible Only</option>
      <option value="hidden" {% if request.GET.visibility == 'hidden' %}selected{% endif %}>Hidden Only</option>
    </select>
  </div>

  <button type="submit" class="btn btn-danger" id="deleteSelectedBtn" disabled
    onclick="return confirm('Are you sure you want to delete the selected products?')">
    üóëÔ∏è Delete Selected
  </button>
</div>


         <!-- Table -->
         <div class="row">
            <div class="col-xl-12 col-12 mb-5">
               <div class="card h-100 card-lg">
                  <div class="card-body p-0">
                     <div class="table-responsive">
                        <table class="table table-centered table-hover text-nowrap table-borderless mb-0 table-with-checkbox">
                           <thead class="bg-light">
                              <tr>
                                 <th style="width: 30px;">
                                    <div class="form-check">
                                       <input class="form-check-input" type="checkbox" id="checkAll" />
                                    </div>
                                 </th>
                                 <th style="width: 80px;">Image</th>
                                 <th>Product Name</th>
                                 <th>Subcategory</th>
                                 <th>Brand</th>
                                 <th>Status</th>
                                 <th>Price</th>
                                 <th>Created</th>
                                 <th>Visibility</th>
                                 <th class="text-end">Actions</th>
                              </tr>
                           </thead>
                           <tbody>
                              {% if products %}
                              {% for p in products %}
                              <tr 
  {% if p.disapprove_reason %} 
    data-bs-toggle="tooltip" 
    title="{{ p.disapprove_reason }}" 
  {% endif %} 
  class="{% if not p.is_active %}hidden-product{% endif %}">

                                 <td>
                                    <div class="form-check">
                                       <input class="form-check-input product-checkbox" type="checkbox" name="selected_products" value="{{ p.id }}">
                                    </div>
                                 </td>
                                 <td style="position: relative;">
   <div class="position-relative d-inline-block">
      {% if p.main_image %}
         <img src="/media/{{ p.main_image }}" alt="{{ p.title }}" class="icon-shape icon-md rounded-2" />
      {% else %}
         <img src="{% static 'assets/images/placeholder.png' %}" alt="No image" class="icon-shape icon-md rounded-2" />
      {% endif %}

      <!-- üè∑Ô∏è Stock / Sale Badge -->
      <div class="position-absolute top-0 start-0 translate-middle-y ms-1 mt-1">
         {% if p.stock <= 0 %}
            <span class="badge bg-secondary">Coming Soon</span>
         {% elif p.stock < 10 %}
            <span class="badge bg-warning text-dark">Low Stock ({{ p.stock }})</span>
         {% elif p.sale_price and p.sale_price|floatformat:2 < p.price|floatformat:2 %}
            <span class="badge bg-danger">Sale</span>
         {% endif %}
      </div>
   </div>
</td>
                                 <td>
                                    {{ p.title }}</td>
                                 <td>{{ p.subcategory_name|default:"‚Äî" }}</td>
                                 <td>{{ p.brand_name|default:"‚Äî" }}</td>
                                 <td>
                                    {% if p.pending_approval %}
                                       <span class="badge bg-warning text-dark">Pending Approval</span>
                                    {% elif p.approved %}
                                       <span class="badge bg-success">Approved</span>
                                    {% elif p.disapproved %}
                                       <span class="badge bg-danger">Disapproved</span>
                                    {% else %}
                                       <span class="badge bg-secondary">Unknown</span>
                                    {% endif %}
                                 </td>
                                 <td>‚Çπ{{ p.price|floatformat:2 }}</td>
                                 <td>{{ p.created_at|date:"d M Y" }}</td>
                                 <td>
  <div class="d-flex align-items-center">
    <div class="form-check form-switch me-2">
      <input class="form-check-input toggle-product"
             type="checkbox"
             data-id="{{ p.id }}"
             {% if p.is_active %}checked{% endif %}>
    </div>
    {% if p.is_active %}
      <span class="badge bg-success visibility-badge">Visible</span>
    {% else %}
      <span class="badge bg-secondary visibility-badge">Hidden</span>
    {% endif %}
  </div>
</td>



                                 <td class="text-end">
                                    <div class="dropdown">
                                       <a href="#" class="text-reset" data-bs-toggle="dropdown" aria-expanded="false">
                                          <i class="feather-icon icon-more-vertical fs-5"></i>
                                       </a>
                                       <ul class="dropdown-menu dropdown-menu-end">
                                          <li>
                                             <a class="dropdown-item" href="{% url 'edit-product' p.id %}">
                                                <i class="bi bi-pencil-square me-2"></i>Edit
                                             </a>
                                          </li>
                                          <li>
                                             <a class="dropdown-item text-danger" href="{% url 'delete-product' p.id %}"
                                                onclick="return confirm('Are you sure you want to delete this product?')">
                                                <i class="bi bi-trash me-2"></i>Delete
                                             </a>
                                          </li>
                                       </ul>
                                    </div>
                                 </td>
                              </tr>
                              {% endfor %}
                              {% else %}
                              <tr>
                                 <td colspan="8" class="text-center py-4 text-muted">No products found in this category.</td>
                              </tr>
                              {% endif %}
                           </tbody>
                        </table>
                     </div>
                  </div>

                  <!-- Pagination -->
                  {% if total_pages > 1 %}
                  <div class="border-top d-md-flex justify-content-between align-items-center px-6 py-4">
                     <span>Showing {{ products|length }} of {{ total }} entries</span>
                     <nav>
                        <ul class="pagination mb-0">
                           {% if page > 1 %}
                           <li class="page-item">
                              <a class="page-link" href="?page={{ page|add:-1 }}">Previous</a>
                           </li>
                           {% else %}
                           <li class="page-item disabled"><a class="page-link">Previous</a></li>
                           {% endif %}

                           {% for i in 1|to:total_pages %}
                           <li class="page-item {% if i == page %}active{% endif %}">
                              <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                           </li>
                           {% endfor %}

                           {% if page < total_pages %}
                           <li class="page-item"><a class="page-link" href="?page={{ page|add:1 }}">Next</a></li>
                           {% else %}
                           <li class="page-item disabled"><a class="page-link">Next</a></li>
                           {% endif %}
                        </ul>
                     </nav>
                  </div>
                  {% endif %}
               </div>
            </div>
         </div>
      </form>
   </div>
</main>

<!-- ‚úÖ Tooltip & Checkbox Script -->
<script>
document.addEventListener("DOMContentLoaded", function () {
   // Bootstrap tooltips
   var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
   tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
   });

   // Select all / deselect all
   const checkAll = document.getElementById("checkAll");
   const checkboxes = document.querySelectorAll(".product-checkbox");
   const deleteBtn = document.getElementById("deleteSelectedBtn");

   if (checkAll) {
      checkAll.addEventListener("change", function () {
         checkboxes.forEach(cb => cb.checked = this.checked);
         toggleDeleteButton();
      });
   }

   checkboxes.forEach(cb => cb.addEventListener("change", toggleDeleteButton));

   function toggleDeleteButton() {
      const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
      deleteBtn.disabled = !anyChecked;
   }
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const toggles = document.querySelectorAll(".toggle-product");
  const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]")?.value;

  toggles.forEach(toggle => {
    toggle.addEventListener("change", function () {
      const productId = this.dataset.id;

      fetch(`/toggle-product-status/${productId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({}),
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          this.checked = data.new_status; // ‚úÖ ensure UI reflects DB
          const msg = data.new_status
            ? "‚úÖ Product is now visible on site."
            : "üö´ Product is now hidden from site.";
          console.log(msg);
        } else {
          alert(data.message || "Failed to update status.");
        }
      })
      .catch(err => {
        console.error("Error toggling product:", err);
        alert("Error updating product visibility.");
      });
    });
  });
});
</script>

<style>
.badge {
  font-size: 0.75rem;
  transition: all 0.3s ease-in-out;
}
.badge.bg-success {
  background-color: #28a745 !important;
}
.badge.bg-secondary {
  background-color: #6c757d !important;
}
tr.hidden-product {
  opacity: 0.6;
}
</style>

<!-- toggle button -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const toggles = document.querySelectorAll(".toggle-product");
  const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]")?.value;

  toggles.forEach(toggle => {
    toggle.addEventListener("change", function () {
      const productId = this.dataset.id;
      const row = this.closest("tr");
      const badge = row.querySelector(".visibility-badge");

      fetch(`/toggle-product-status/${productId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({})
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          this.checked = data.new_status;

          // Update badge dynamically
          if (badge) {
            badge.textContent = data.new_status ? "Visible" : "Hidden";
            badge.classList.toggle("bg-success", data.new_status);
            badge.classList.toggle("bg-secondary", !data.new_status);
          }
        } else {
          alert(data.message || "Failed to update visibility.");
        }
      })
      .catch(err => {
        console.error("Error updating product visibility:", err);
        alert("Error updating product visibility.");
      });
    });
  });
});
</script>

<!-- visibility dropdown  -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const visibilityFilter = document.getElementById("visibilityFilter");
  if (visibilityFilter) {
    visibilityFilter.addEventListener("change", function() {
      const selected = this.value;
      const url = new URL(window.location.href);
      if (selected === "all") {
        url.searchParams.delete("visibility");
      } else {
        url.searchParams.set("visibility", selected);
      }
      window.location.href = url.toString();
    });
  }
});
</script>

{% endblock %}

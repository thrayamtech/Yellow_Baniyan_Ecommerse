{% extends 'superadmin/adminbase.html' %}
{% load static %}
{% block title %}Brand & Product Analytics - SuperAdmin{% endblock %}
{% block content %}

<main class="main-content-wrapper ">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
      <h3 class="fw-bold mb-2">Brand & Product Analytics Dashboard</h3>
    </div>

    <!-- Filters -->
    <form method="get" class="row g-3 mb-4 bg-light p-3 rounded shadow-sm">
      <div class="col-md-3 col-sm-6">
        <label class="form-label fw-semibold">Start Date</label>
        <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
      </div>
      <div class="col-md-3 col-sm-6">
        <label class="form-label fw-semibold">End Date</label>
        <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
      </div>
      <div class="col-md-3 col-sm-6">
        <label class="form-label fw-semibold">Select Brand</label>
        <select name="brand_id" class="form-select">
          <option value="">-- All Brands --</option>
          {% for b in all_brands %}
            <option value="{{ b.id }}" {% if selected_brand == b.id|stringformat:"s" %}selected{% endif %}>
              {{ b.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3 col-sm-6 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-funnel me-1"></i> Apply Filters
        </button>
      </div>
    </form>

    <!-- Analytics -->
    <div class="row g-4">
      <!-- Left: Brand Summary -->
      <div class="col-lg-5 col-md-12">
        <div class="card shadow-sm h-100 border-0">
          <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center">
            <span>Brand Visit Summary</span>
            <i class="bi bi-graph-up"></i>
          </div>
          <div class="card-body p-0" style="max-height: 420px; overflow-y: auto;">
            <table class="table table-hover table-striped align-middle mb-0">
              <thead class="table-light sticky-top" style="top: 0;">
                <tr>
                  <th>Brand</th>
                  <th class="text-end">Visitors</th>
                </tr>
              </thead>
              <tbody>
                {% for brand in brand_stats %}
                <tr class="brand-row {% if selected_brand == brand.brand_id|stringformat:'s' %}active{% endif %}" data-brandid="{{ brand.brand_id }}">
                  <td>
                    <div class="d-flex align-items-center gap-3">
                      {% if brand.image %}
                        <img src="/media/{{ brand.image }}" alt="{{ brand.brand_name }}"
                             class="brand-click shadow-sm"
                             data-brandid="{{ brand.brand_id }}"
                             style="width:40px;height:40px;object-fit:cover;border-radius:8px;border:2px solid {{ brand.theme_color }};cursor:pointer;">
                      {% else %}
                        <div class="brand-click bg-secondary bg-opacity-25 text-muted d-flex align-items-center justify-content-center"
                             data-brandid="{{ brand.brand_id }}"
                             style="width:40px;height:40px;border-radius:8px;cursor:pointer;">
                          <i class="bi bi-image"></i>
                        </div>
                      {% endif %}
                      <div class="brand-click" data-brandid="{{ brand.brand_id }}" style="cursor:pointer;">
                        <div class="fw-semibold mb-0">{{ brand.brand_name }}</div>
                      </div>
                    </div>
                  </td>
                  <td class="text-end"><span class="fw-bold">{{ brand.total_visitors }}</span></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Right: Product Table -->
      <div class="col-lg-7 col-md-12">
        <div class="card shadow-sm h-100 border-0">
          <div class="card-header bg-success text-white fw-bold d-flex justify-content-between align-items-center">
            <span>Product View Details {% if selected_brand_name %}<small class="fw-normal text-light">({{ selected_brand_name }})</small>{% endif %}</span>
            <i class="bi bi-box-seam"></i>
          </div>
          <div class="card-body p-3" style="max-height: 420px; overflow-y: auto;">
            {% if products_by_brand %}
              {% for brand, plist in products_by_brand.items %}
                {% if not selected_brand_name or brand == selected_brand_name %}
                  <div class="mb-4">
                    <h6 class="fw-bold border-bottom pb-1" style="color: {{ plist.0.theme_color|default:'#198754' }}">
                      {{ brand }}
                    </h6>
                    <div class="table-responsive">
                      <table class="table table-bordered align-middle mb-0">
                        <thead class="table-light sticky-top" style="top: 0;">
                          <tr>
                            <th>Product</th>
                            <th class="text-end">Unique Viewers</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for p in plist %}
                          <tr>
                            <td>{{ p.product_title }}</td>
                            <td class="text-end fw-bold">{{ p.total_views }}</td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            {% else %}
              <div class="text-center text-muted py-4">
                <i class="bi bi-exclamation-circle me-1"></i> No product views found for this selection.
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".brand-click").forEach(el => {
      el.addEventListener("click", () => {
        const brandId = el.dataset.brandid;
        if (brandId) {
          const url = new URL(window.location.href);
          url.searchParams.set("brand_id", brandId);
          window.location.href = url.toString();
        }
      });
    });
  });
</script>

<style>
.brand-row:hover {
  background-color: #f8f9fa;
  cursor: pointer;
  transition: 0.2s ease-in-out;
}
.brand-row.active {
  background-color: #e7f1ff !important;
  border-left: 4px solid #0d6efd;
}
.card-header i {
  opacity: 0.8;
}
@media (max-width: 767px) {
  .card-body {
    font-size: 0.9rem;
  }
}
</style>

{% endblock %}

{% extends "base.html" %}
{% load static %}
{% block title %}{{ brand.name }} - Products{% endblock %}
{% block content %}
<style>
  :root {
    --brand-color: {{ theme_color|default:'#0d6efd' }};
  }

  /* âœ… Use brand theme color throughout the page */
  .btn-primary {
    background-color: var(--brand-color) !important;
    border-color: var(--brand-color) !important;
  }

  .btn-primary:hover {
    background-color: color-mix(in srgb, var(--brand-color), black 15%) !important;
    border-color: color-mix(in srgb, var(--brand-color), black 15%) !important;
  }

  .text-primary {
    color: var(--brand-color) !important;
  }

  .badge.bg-danger,
  .badge.bg-warning,
  .badge.bg-secondary {
    background-color: var(--brand-color) !important;
    color: #fff !important;
  }

  h4.fw-bold, h5, h6, .accordion-button:not(.collapsed) {
    color: var(--brand-color) !important;
  }

  .accordion-button:focus {
    border-color: var(--brand-color) !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, .25);
  }

  /* âœ… Product card accent */
  .card-product {
    border-top: 3px solid var(--brand-color);
    transition: all 0.3s ease;
  }

  .card-product:hover {
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    transform: translateY(-3px);
  }

  /* âœ… Custom scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-thumb {
    background-color: var(--brand-color);
    border-radius: 8px;
  }
</style>


<main class="py-5">
    <div class="container">
        <div class="row gx-5">
            <!-- Sidebar -->
            <aside class="col-lg-3 col-md-4 mb-4">
                <h5 class="mb-3">Categories</h5>
                <div class="accordion" id="brandCategoryAccordion">
                    {% for cat in categories %}
                    <div class="accordion-item mb-2 border-0">
                        <h2 class="accordion-header" id="heading{{ cat.id }}">
                            <button class="accordion-button {% if not is_active %}collapsed{% endif %}" type="button"
                                data-bs-toggle="collapse" data-bs-target="#collapse{{ cat.id }}" {% if is_active %}
                                aria-expanded="true" {% else %}aria-expanded="false" {% endif %}
                                aria-controls="collapse{{ cat.id }}">
                                {{ cat.name }}
                            </button>
                        </h2>
                        <div id="collapse{{ cat.id }}"
                            class="accordion-collapse collapse {% if is_active %}show{% endif %}"
                            aria-labelledby="heading{{ cat.id }}" data-bs-parent="#brandCategoryAccordion">

                            <div class="accordion-body py-2">
                                <ul class="list-unstyled ms-2">
                                    <li class="mb-1">
                                        <a href="?category={{ cat.id }}"
                                            class="text-decoration-none small {% if active_category and active_category.id|stringformat:'s' == cat.id|stringformat:'s' and not active_subcategory %}fw-bold text-primary{% else %}text-dark{% endif %}">
                                            All {{ cat.name }}
                                        </a>
                                    </li>
                                    {% for sub in subcategories %}
                                    {% if sub.category_id == cat.id %}
                                    <li class="mb-1">
                                        <a href="?category={{ cat.id }}&sub={{ sub.id }}"
                                            class="text-decoration-none small {% if active_subcategory and active_subcategory.id == sub.id %}fw-bold text-primary{% else %}text-muted{% endif %}">
                                            {{ sub.name }}
                                        </a>
                                    </li>
                                    {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% if active_category or active_subcategory %}
                <a href="{% url 'brand-products' brand.id %}" class="btn btn-outline-secondary btn-sm mt-3 w-100">
                    <i class="bi bi-x-circle me-1"></i> Clear Filters
                </a>
                {% endif %}
            </aside>

 
            <!-- Product Grid -->
            <section class="col-lg-9 col-md-8">
                
                           <div class="mb-5">
  <img src="/media/{{ brand.image }}" alt="{{ brand.name }}" 
       style="width:100px;height:100px;object-fit:contain;border-radius:12px;
              border:4px solid {{ theme_color }};box-shadow:0 0 10px {{ theme_color }}44;">
  <h3 class="fw-bold mt-3" style="color: {{ theme_color }}">{{ brand.name }}</h3>
</div>


                <div class="row g-4 row-cols-xl-4 row-cols-lg-3 row-cols-md-3 row-cols-2">
                    {% for p in products %}
                    <div class="col">
                        <div class="card card-product h-100">
                            <div class="card-body">
                                <div class="text-center position-relative">
                                    <div class="position-absolute top-0 start-0">
                                        {% if p.stock <= 0 %}
                                        <span class="badge bg-secondary">Out of Stock</span>
                                        {% elif p.sale_price and p.sale_price|floatformat:2 < p.price|floatformat:2 %}
                                        <span class="badge bg-danger">Sale</span>
                                        {% endif %}
                                    </div>

                                    <a href="{% url 'view-product' p.id %}">
                                        <img src="/media/{{ p.main_image }}" class="img-fluid rounded mb-3"
                                            style="height:220px;object-fit:cover;" alt="{{ p.title }}">
                                    </a>

                                    <div class="card-product-action">
                                        <a href="javascript:void(0);" class="btn-action"
                                            onclick="addToWishlist({{ p.id }})" title="Add to Wishlist">
                                            <i class="bi bi-heart"></i>
                                        </a>
                                    </div>
                                </div>

                                <div class="text-small mb-1">
                                    <small class="text-muted">{{ p.category_name }} â€º {{ p.subcategory_name|default:"General" }}</small>
                                </div>

                                <h6 class="fw-semibold text-truncate">
                                    <a href="{% url 'view-product' p.id %}" class="text-dark">{{ p.title }}</a>
                                </h6>

                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div>
                                        <span class="text-dark">â‚¹{{ p.sale_price|default:p.price }}</span>
                                        {% if p.sale_price %}
                                        <span class="text-decoration-line-through text-muted">â‚¹{{ p.price }}</span>
                                        {% endif %}
                                    </div>
                                    <div>
                                        {% if p.stock <= 0 %}
                                        <button class="btn btn-secondary btn-sm" disabled>Out of Stock</button>
                                        {% else %}
                                        <button class="btn btn-primary btn-sm" onclick="addToCart({{ p.id }})">Add</button>
                                        {% endif %}
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted py-5">
                        <p>No products available under this brand.</p>
                    </div>
                    {% endfor %}
                </div>
            </section>
        </div>
    </div>
</main>

<script>
   async function addToCart(productId) {
      const csrfToken = '{{ csrf_token }}';
      const res = await fetch(`/add-to-cart/${productId}/`, {
         method: "POST",
         headers: { "X-CSRFToken": csrfToken },
      });

      const data = await res.json();

      if (data.status === "added") {
         Swal.fire({
            icon: "success",
            title: "Added to Cart ðŸ›’",
            text: data.message || "Product successfully added.",
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true,
            background: "#f6fff5",
            iconColor: "#28a745"
         });
         if (data.cart_count !== undefined) setCartCount(data.cart_count);
      }
      else if (data.status === "updated") {
         Swal.fire({
            icon: "info",
            title: "Already in Cart",
            text: "Quantity updated in your cart.",
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 2000,
            background: "#fff7e6",
            iconColor: "#ff9900"
         });
         if (data.cart_count !== undefined) setCartCount(data.cart_count);
      }
      else if (data.status === "login_required") {
         Swal.fire({
            icon: "warning",
            title: "Login Required",
            text: "Please login to add products to cart.",
            confirmButtonText: "Login Now",
            confirmButtonColor: "#ff9900"
         }).then(result => {
            if (result.isConfirmed) {
               window.location.href = "{% url 'userlogin' %}";
            }
         });
      }
      else {
         Swal.fire({
            icon: "error",
            title: "Error",
            text: data.message || "Something went wrong. Try again later.",
            confirmButtonColor: "#d33"
         });
      }
   }


   async function addToWishlist(productId) {
      const csrfToken = '{{ csrf_token }}';
      const res = await fetch(`/add-to-wishlist/${productId}/`, {
         method: "POST",
         headers: { "X-CSRFToken": csrfToken }
      });
      const data = await res.json();

      if (data.status === "added") {
         Swal.fire({
            icon: "success",
            title: "Added to Wishlist â¤ï¸",
            text: data.message || "Product added successfully.",
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true,
            background: "#fff5f8",
            iconColor: "#ff4081"
         });
         updateWishlistCount(1);
      }
      else if (data.status === "exists") {
         Swal.fire({
            icon: "info",
            title: "Already in Wishlist",
            text: "This product is already saved.",
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 2000,
            background: "#fdf6ec",
            iconColor: "#f39c12"
         });
      }
      else if (data.status === "login_required") {
         Swal.fire({
            icon: "warning",
            title: "Login Required",
            text: "Please login to use wishlist.",
            confirmButtonText: "Login Now",
            confirmButtonColor: "#ff9900"
         }).then(res => {
            if (res.isConfirmed) window.location.href = "{% url 'userlogin' %}";
         });
      }
   }

   function updateWishlistCount(change) {
      const badge = document.getElementById("wishlistBadge");
      if (badge) {
         let count = parseInt(badge.textContent) || 0;
         badge.textContent = Math.max(0, count + change);
      }
   }
</script>

{% endblock %}

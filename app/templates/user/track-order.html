{% extends 'user/userbase.html' %}
{% block title %}Track Order - {{ order.product_title }}{% endblock %}
{% block content %}

<div class="col-lg-9 col-md-8 col-12">
  <div class="py-5 px-md-5">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
      <h3 class="mb-3 mb-md-0">
        Order <span class="text-muted">#{{ order.order_id }}</span>
      </h3>
      <a href="{% url 'order-details' %}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Back to Orders
      </a>
    </div>

    <!-- Order Overview -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body d-flex flex-wrap align-items-center justify-content-between">
        <div class="d-flex align-items-center flex-wrap">
          <div class="me-3 mb-3 mb-md-0">
            <img src="/media/{{ order.product_image }}" alt="{{ order.product_title }}" class="rounded border" width="90" height="90" style="object-fit: cover;">
          </div>
          <div>
            <h5 class="mb-1">{{ order.product_title }}</h5>
            <p class="text-muted mb-1">₹{{ order.total_amount }}</p>
            <small class="text-muted">Ordered on {{ order.created_at|date:"M d, Y h:i A" }}</small>
          </div>
        </div>
        <div class="text-end">
          <span class="badge {% if tracking.status == 'Delivered' %}bg-success{% elif tracking.status == 'Cancelled' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
            {{ tracking.status|default:"Order Placed" }}
          </span>
          {% if tracking.status != "Delivered" and tracking.status != "Cancelled" %}
          <button class="btn btn-outline-danger btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#cancelModal">
            <i class="bi bi-x-circle"></i> Cancel Order
          </button>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Delivery Progress -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body">
        <h5 class="mb-4">Delivery Progress</h5>
        <div class="progress mb-3" style="height: 8px;">
          {% with s=tracking.status %}
          {% if s == 'Order Placed' %}
          <div class="progress-bar bg-warning" style="width: 10%"></div>
          {% elif s == 'Packed' %}
          <div class="progress-bar bg-info" style="width: 30%"></div>
          {% elif s == 'Shipped' %}
          <div class="progress-bar bg-primary" style="width: 60%"></div>
          {% elif s == 'Out for Delivery' %}
          <div class="progress-bar bg-info" style="width: 80%"></div>
          {% elif s == 'Delivered' %}
          <div class="progress-bar bg-success" style="width: 100%"></div>
          {% elif s == 'Cancelled' %}
          <div class="progress-bar bg-danger" style="width: 100%"></div>
          {% endif %}
          {% endwith %}
        </div>
        <div class="d-flex justify-content-between small text-muted">
          <div>Order Placed</div>
          <div>Packed</div>
          <div>Shipped</div>
          <div>Out for Delivery</div>
          <div>Delivered</div>
        </div>
        <p class="text-muted mt-3 mb-0">Last updated: {{ tracking.updated_at|date:"M d, Y h:i A" }}</p>
      </div>
    </div>

    <!-- Delivery & Payment Info -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body">
        <div class="row g-4">
          <div class="col-md-6">
            <h6 class="fw-semibold mb-2"><i class="bi bi-geo-alt"></i> Delivery Address</h6>
            <p class="mb-0 text-muted">
              {% if order.address %}
              {{ order.address.first_name }} {{ order.address.last_name }}<br>
              {{ order.address.address_line1 }}, {{ order.address.address_line2 }}<br>
              {{ order.address.city }}, {{ order.address.state }} - {{ order.address.zip_code }}<br>
              {{ order.address.country }}<br>
              Phone: {{ order.address.phone }}
              {% else %}
              Not available
              {% endif %}
            </p>
          </div>
          <div class="col-md-6">
            <h6 class="fw-semibold mb-2"><i class="bi bi-credit-card"></i> Payment Details</h6>
            <p class="mb-0 text-muted">
              Payment Method: <span class="text-dark fw-medium">{{ order.payment_method|default:"Online Payment" }}</span><br>
              Payment Status: 
              {% if order.payment_status == "success" %}
                <span class="badge bg-success">Paid</span>
              {% else %}
                <span class="badge bg-warning text-dark">Pending</span>
              {% endif %}
              <br>
              Total Paid: ₹{{ order.total_amount }}
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Status Message -->
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        {% if tracking.status == "Delivered" %}
        <div class="alert alert-success mb-0"><i class="bi bi-check-circle"></i> Your order was delivered successfully!</div>
        {% elif tracking.status == "Cancelled" %}
        <div class="alert alert-danger mb-0"><i class="bi bi-x-circle"></i> This order was cancelled.</div>
        {% else %}
        <div class="alert alert-info mb-0"><i class="bi bi-truck"></i> Your order is currently {{ tracking.status|default:"being processed" }}.</div>
        {% endif %}
      </div>
    </div>

  </div>
</div>

<!-- Cancel Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="cancelForm" method="POST" action="{% url 'cancel-order' order.order_id %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="cancelModalLabel">Cancel Order</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-3">Please select a reason for cancellation:</p>
          <select name="reason" class="form-select mb-3" required>
            <option value="" selected disabled>Choose reason</option>
            <option>Ordered by mistake</option>
            <option>Item not needed anymore</option>
            <option>Found a better price elsewhere</option>
            <option>Delivery taking too long</option>
            <option>Other</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keep Order</button>
          <button type="submit" class="btn btn-danger">Cancel Order</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}
